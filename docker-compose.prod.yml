# Example docker compose file for running the complete MediaSet stack in production
#
# This file includes all services: API, UI, and MongoDB
#
# Prerequisites:
# - Set required environment variables in a .env file or pass them directly
#
# Required environment variables:
#   - MONGODB_CONNECTION_STRING: MongoDB connection string (default: mongodb://mongo:27017)
#
# Optional environment variables (for barcode/metadata lookup features):
#   - OPENLIBRARY_CONTACT_EMAIL: Your email for OpenLibrary API (required for book lookup)
#   - TMDB_BEARER_TOKEN: TMDB API bearer token (required for movie lookup)
#   - GIANTBOMB_API_KEY: GiantBomb API key (required for game lookup)
#   - MUSICBRAINZ_USER_AGENT: MusicBrainz user agent (optional, e.g., "MyApp/1.0 (contact@example.com)")
#   - UPCITEMDB_API_KEY: UpcItemDb API key (optional, but improves lookup accuracy)

version: '3.8'

services:
  mediaset-api:
    image: ghcr.io/paulmfischer/mediaset-api:latest
    container_name: mediaset-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Core API settings
      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: "Production"
      
      # Database configuration
      MediaSetDatabaseSettings__ConnectionString: "${MONGODB_CONNECTION_STRING:-mongodb://mongo:27017}"
      MediaSetDatabaseSettings__DatabaseName: "MediaSet"
      
      # Cache settings
      CacheSettings__EnableCaching: "true"
      CacheSettings__DefaultCacheDurationMinutes: "10"
      CacheSettings__MetadataCacheDurationMinutes: "10"
      CacheSettings__StatsCacheDurationMinutes: "10"
      
      # Image storage configuration
      ImageConfiguration__StoragePath: "/app/data/images"
      ImageConfiguration__MaxFileSizeMb: "5"
      ImageConfiguration__AllowedImageExtensions: "jpg,jpeg,png"
      ImageConfiguration__HttpTimeoutSeconds: "30"
      
      # OpenLibrary configuration (for book lookup)
      # OpenLibraryConfiguration__BaseUrl: "https://openlibrary.org/"
      # OpenLibraryConfiguration__Timeout: "30"
      # OpenLibraryConfiguration__ContactEmail: "[ReplaceThis]"
      
      # TMDB configuration (for movie lookup)
      # TmdbConfiguration__BaseUrl: "https://api.themoviedb.org/3/"
      # TmdbConfiguration__BearerToken: "[ReplaceThis]"
      # TmdbConfiguration__Timeout: "10"
      
      # UpcItemDb configuration (for barcode lookup)
      # UpcItemDbConfiguration__BaseUrl: "https://api.upcitemdb.com/"
      # UpcItemDbConfiguration__Timeout: "10"
      
      # GiantBomb configuration (for game lookup)
      # GiantBombConfiguration__BaseUrl: "https://www.giantbomb.com/api/"
      # GiantBombConfiguration__ApiKey: "[ReplaceThis]"
      # GiantBombConfiguration__Timeout: "10"
      
      # MusicBrainz configuration (for music lookup)
      # MusicBrainzConfiguration__BaseUrl: "https://musicbrainz.org/"
      # MusicBrainzConfiguration__Timeout: "10"
      # MusicBrainzConfiguration__UserAgent: "${MUSICBRAINZ_USER_AGENT:-MediaSet/1.0 (https://github.com/paulmfischer/MediaSet)}"
      
      # Seq logging configuration (for centralized structured logging)
      # See Setup/SEQ_SETUP.md for detailed configuration guide
      # ExternalLogging__Enabled: "true"
      # ExternalLogging__SeqUrl: "[ReplaceThis]"
      
      # HTTP logging exclusions (reduces noise in logs by excluding specific paths)
      # HttpLoggingOptions__ExcludedPaths__0: "/api/logs"
      # HttpLoggingOptions__ExcludedPaths__1: "/health"
      # HttpLoggingOptions__ExcludedPaths__2: "/health/ready"
      # HttpLoggingOptions__ExcludedPaths__3: "/health/live"
      # HttpLoggingOptions__ExcludePathStartsWith__0: "/api/health"
      # HttpLoggingOptions__ExcludePathStartsWith__1: "/swagger"

      # Background image lookup service configuration
      # Automatically finds and downloads cover images for entities missing them
      # See Setup/BACKGROUND_IMAGE_LOOKUP_SETUP.md for detailed configuration guide
      # BackgroundImageLookupConfiguration__Enabled: "true"
      # BackgroundImageLookupConfiguration__Schedule: "0 2 * * *"
      # BackgroundImageLookupConfiguration__MaxRuntimeMinutes: "60"
      # BackgroundImageLookupConfiguration__BatchSize: "25"
      # BackgroundImageLookupConfiguration__RequestsPerMinute: "30"

    volumes:
      # Persist uploaded images
      - mediaset-images:/app/data/images
    
    depends_on:
      - mongo
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - mediaset
  
  mediaset-ui:
    image: ghcr.io/paulmfischer/mediaset-ui:latest
    container_name: mediaset-ui
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Server-side API URL - for Remix server to call API (uses Docker container name)
      apiUrl: "${API_URL:-http://mediaset-api:8080}"
      
      # Client-side API URL - for browser to access API (must be externally accessible)
      # In production, this should be the public URL of your API
      clientApiUrl: "[ReplaceThis]"
      
      # Node environment
      NODE_ENV: "production"
      
      # Optional: Enable detailed error messages (not recommended for production)
      # SHOW_ERROR_DETAILS: "false"
    
    depends_on:
      - mediaset-api
    
    networks:
      - mediaset
  
  mongo:
    image: mongo:7.0
    container_name: mediaset-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: "MediaSet"
    volumes:
      - mediaset-db:/data/db
    networks:
      - mediaset

volumes:
  mediaset-db:
    driver: local
  mediaset-images:
    driver: local

networks:
  mediaset:
    driver: bridge
