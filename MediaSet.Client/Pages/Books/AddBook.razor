@page "/books/add"
@inject HttpClient Http
@inject IUriHelper UriHelper

<h3>Add Book</h3>
<NavLink class="nav-link" href="books">
    <span class="oi oi-book" aria-hidden="true"></span> Books
</NavLink>
<EditForm Model="@bookViewModel" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="title">Title:</label>
        <InputText id="title" Class="form-control" @bind-Value="@bookViewModel.Title" />
    </div>

    <div class="form-group">
        <label for="isb">ISBN:</label>
        <InputText id="isbn" Class="form-control" @bind-Value="@bookViewModel.ISBN" />
    </div>

    <div class="form-group">
        <label for="subTitle">Sub Title:</label>
        <InputText id="subTitle" Class="form-control" @bind-Value="@bookViewModel.SubTitle" />
    </div>

    <div class="form-group">
        <label for="numberOfPages">Number of Pages:</label>
        <InputNumber id="numberOfPages" Class="form-control" @bind-Value="@bookViewModel.NumberOfPages" />
    </div>

    <div class="form-group">
        <AuthorMultiSelect OnAuthorAdded="@((AuthorViewModel author) => AuthorAdded(author))"/>
    </div>

    <div class="form-group">
        <Autocomplete Collection="bookViewModel.Publishers" Title="Publisher:" AddNewLabel="Add new publisher: " OnItemSelected="@((PublisherViewModel selectedItem) => PublisherSelected(selectedItem))" OnAddNewItem="@AddNewPublisher">
            <ItemTemplate Context="Publisher">@Publisher.Name</ItemTemplate>
        </Autocomplete>
    </div>

    <div class="form-group">
        <Autocomplete Collection="bookViewModel.Formats" Title="Format:" AddNewLabel="Add new format: " OnItemSelected="@((FormatViewModel selectedItem) => FormatSelected(selectedItem))" OnAddNewItem="@AddNewFormat">
            <ItemTemplate Context="Format">@Format.Name</ItemTemplate>
        </Autocomplete>
    </div>

    @if (!Saving)
    {
        <button class="btn btn-primary" type="submit">Submit</button>
    }
    else
    {
        <button class="btn btn-primary" type="button" disabled><Loading Message="Saving..." InButton="true" />Saving...</button>
    }
</EditForm>

@code {
    private IList<TempData> Data = new List<TempData>
    {
        new TempData { Id = 1, Name = "hi" },
        new TempData { Id = 2, Name = "fred" },
        new TempData { Id = 3, Name = "bye" }
    };
    private AddBookViewModel bookViewModel = new AddBookViewModel();
    private bool Saving = false;

    protected override async Task OnInitAsync()
    {
        bookViewModel.Publishers = await Http.GetJsonAsync<IEnumerable<PublisherViewModel>>("api/metadata/publishers");
        bookViewModel.Formats = await Http.GetJsonAsync<IEnumerable<FormatViewModel>>("api/metadata/formats");
    }

    private async void HandleValidSubmit()
    {
        Saving = true;
        await Http.SendJsonAsync(HttpMethod.Post, "api/book/add", bookViewModel);
        UriHelper.NavigateTo("/books");
    }

    private void AuthorAdded(AuthorViewModel author)
    {
        bookViewModel.Authors.Add(author);
    }

    private void PublisherSelected(PublisherViewModel item)
    {
        bookViewModel.PublisherId = item.Id;
    }

    private void AddNewPublisher(string newValue)
    {
        bookViewModel.Publisher = new PublisherViewModel { Name = newValue };
    }

    private void FormatSelected(FormatViewModel item)
    {
        bookViewModel.FormatId = item.Id;
    }

    private void AddNewFormat(string newValue)
    {
        bookViewModel.Format = new FormatViewModel { Name = newValue };
    }

    private class TempData
    {
        public int Id { get; set; }
        public string Name { get; set; }
    }
}
