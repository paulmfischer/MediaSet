# Development Dockerfile for .NET API with hot reload support
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS development

WORKDIR /app

# Install debugger
RUN curl -sSL https://aka.ms/getvsdbgsh | bash /dev/stdin -v latest -l /vsdbg

# Create a non-root user for development
RUN groupadd -g 1000 app && useradd -r -u 1000 -g app app
RUN chown -R app:app /app

# Install dotnet tools globally for the app user
USER app
ENV PATH="${PATH}:/home/app/.dotnet/tools"
RUN dotnet tool install --global dotnet-ef
RUN dotnet tool install --global dotnet-watch

# Switch back to root to install system dependencies if needed
USER root

# Copy project files
COPY --chown=app:app *.csproj ./
USER app
RUN dotnet restore

# Copy source code
USER root
COPY --chown=app:app . ./
USER app

# Set environment variables for development
ENV DOTNET_USE_POLLING_FILE_WATCHER=1
ENV ASPNETCORE_ENVIRONMENT=Development
ENV DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1

EXPOSE 5000 5001

# Default command - can be overridden in docker-compose
CMD ["dotnet", "watch", "run", "--urls", "http://0.0.0.0:5000;https://0.0.0.0:5001"]